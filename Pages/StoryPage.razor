@inject StoryRepository StoryRepo

@page "/stories/{Slug}"

@using SudaTales.Models
@using SudaTales.Data

@if (_story is null || _activeChapter is null)
{
    <p>Story not found.</p>
}
else
{
    <div class="story-shell">
        <!-- Left: Chapters -->
        <aside class="story-sidebar left">
            <StorySidebar
                Story="_story"
                ActiveChapter="_activeChapter"
                OnChapterSelected="SetActiveChapter" />
        </aside>

        <!-- Center: Reading -->
       <main class="story-content"
      @onclick="ClearParagraphSelection">
    <h1>@_story.Title</h1>
    <h2>@_activeChapter.Title</h2>

    @foreach (var paragraph in _activeChapter.Paragraphs)
    {
        <AnnotatableParagraph
            Paragraph="paragraph"
            IsActive="(_activeParagraph?.Id == paragraph.Id)"
            OnSelected="SetActiveParagraph" />
    }
</main>

        <!-- Right: Annotations -->
        <aside class="story-sidebar right">
            <ChapterAnnotations
                StorySlug="@_story.Slug"
                ChapterId="@_activeChapter.Id"
                ActiveParagraph="_activeParagraph" />
        </aside>
    </div>
}

@code {
    [Parameter]
    public string Slug { get; set; } = string.Empty;

    private StoryModel? _story;
    private ChapterModel? _activeChapter;
    private Paragraph? _activeParagraph;

 protected override async Task OnParametersSetAsync()
{
    _story = await StoryRepo.GetAsync(Slug);

    if (_story is not null)
        _activeChapter ??= _story.Chapters.FirstOrDefault();
}


    private void SetActiveChapter(ChapterModel chapter)
    {
        _activeChapter = chapter;
        _activeParagraph = null; // reset paragraph when chapter changes
    }

    private void SetActiveParagraph(Paragraph paragraph)
    {
        _activeParagraph = paragraph;
    }
    private void ClearParagraphSelection()
{
    _activeParagraph = null;
}
}
